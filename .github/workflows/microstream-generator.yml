name: Generate Microstreams

on:
  schedule:
    - cron: "*/45 * * * *"   # كل 45 دقيقة — نبضة قصيرة
  workflow_dispatch:

jobs:
  build-microstream:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Create microstreams folder if missing
      run: mkdir -p microstreams

    - name: Generate Microstream File
      id: gen
      run: |
        timestamp=$(date +"%Y%m%d-%H%M%S")
        filename="microstream-${timestamp}.md"
        filepath="microstreams/$filename"

        echo "---" > $filepath
        echo "title: Microstream $timestamp" >> $filepath
        echo "date: $(date -Is)" >> $filepath
        echo "---" >> $filepath
        echo "" >> $filepath
        echo "Autogenerated microstream at $timestamp" >> $filepath
        echo "" >> $filepath
        echo "Seed reference: RX-HCM Node-01" >> $filepath

        echo "filename=$filename" >> $GITHUB_OUTPUT
        
    - name: Pull latest before pushing
      run:  git pull --rebase
     
    - name: Commit Microstream
      run: |
        git config --local user.name "AhmedPeaRL"
        git config --local user.email "blackpearl88622@gmail.com"
        git pull --rebase
        git add microstreams/
        git commit -m "Add microstream: ${{ steps.gen.outputs.filename }}" || true
        git push
